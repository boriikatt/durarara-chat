<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Anonymous Chat</title>
    
    <!-- 
      FIX #1: Swapped the script for a pre-compiled Tailwind CSS file.
      This is much more likely to load in Firefox from a file:/// path.
    --><link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    
    <!-- Google Font: JetBrains Mono --><link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">
    
    <!-- Custom styles for the DRRR!! theme --><style>
        body {
	    font-family: 'JetBrains Mono', monospace;
	    background-color: #f0f0f0;
	    color: #f0f0f0;
	    overflow: hidden;
	    display: flex;
	    font-size: 14px;
	    font-weight: 400;

        /* --- NEW: Dynamic Height Fix --- */
        /* Fallback for browsers without JS */
        height: 100vh; 
        /* Use a CSS variable set by JS to get true inner height */
        height: var(--app-height, 100vh);
        /* --- END: Dynamic Height Fix --- */
	}

	/* Mobile font adjustments */
	@media (max-width: 640px) {
	    body {
	        font-size: 12px;
	    }
	}
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #111;
        }
        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #444;
        }

        /* Login screen styles */
        #login-view {
            /* This screen remains dark */
            background-color: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(5px);
        }

        .login-box {
            background-color: #111; /* Darkened login box */
            border: 1px solid #333;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.1);
        }
        
        /* Special override for the password screen's box */
        #password-view {
            /* This screen also remains dark */
            background-color: #000;
        }
        #password-view .login-box {
            background-color: transparent; /* Make password box blend in */
            border: none;
            box-shadow: none;
        }

        /* --- LOGIN SCREEN INPUT STYLE --- */
        .login-input {
	    font-family: 'JetBrains Mono', monospace;
	    background-color: #ffffff;
	    border: 2px solid #888;
	    color: #000000;
	    padding: 0.75rem;
	    border-radius: 8px;
	    transition: all 0.2s ease;
	    font-size: 16px; /* Prevents iOS zoom on focus */
	}
        .login-input:focus {
            outline: none;
            border-color: #aaa;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
        }


        /* --- CHAT SCREEN STYLES (NEW) --- */
        .drrr-input {
            font-family: 'JetBrains Mono', monospace;
            background-color: #ffffff; /* White background */
            /* border: 1px solid #ccc; -- REMOVED AS REQUESTED */
            border: none; /* <-- REPLACED */
            color: #000000; /* Black text */
            padding: 0.75rem;
            border-radius: 4px; /* Less curved corners */
            /* transition: all 0.2s ease; -- REMOVED AS REQUESTED */
            resize: none; /* Disable textarea resize handle */
        }

        /* NEW RULE: Remove the browser's default focus outline */
        .drrr-input:focus {
            outline: none;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2); /* Optional: add a subtle shadow */
        }
        
        .drrr-btn {
            font-family: 'JetBrains Mono', monospace;
            background-color: #d3d3d3; /* Light gray */
            border: 1px solid #000; /* Lessened black border */
            color: #000000; /* Black text for contrast */
            padding: 0.25rem 2.5rem; /* Reduced vertical padding */
            border-radius: 9999px; /* Pill shape */
            transition: all 0.2s ease;
            cursor: pointer;
            font-weight: bold;
            letter-spacing: 0.1em;
        }

        .drrr-btn:hover {
            background-color: #e0e0e0; /* Slightly lighter gray on hover */
            border-color: #000; /* Keep black border */
        }
        
        .drrr-btn:disabled {
            background-color: #a0a0a0; /* Darker gray when disabled */
            color: #555;
            cursor: not-allowed;
            border-color: #000; /* Keep black border when disabled */
        }
        /* --- END CHAT SCREEN STYLES --- */
        
        /* Color picker (REMOVED) */
        
        /* --- ICON PICKER STYLES --- */
        
        .icon-swatch {
            width: 60px; /* Width */
            height: 60px; /* Height */
            border-radius: 4px; /* Rounded corners */
            cursor: pointer;
            border: 3px solid #444; /* Dark border */
            
            /* FIX: 
              1. Added 'border-color' to the transition so it fades smoothly.
              2. Added 'will-change' to hint to the browser to optimize the 'transform' animation.
            */
            transition: transform 0.2s ease, border-color 0.2s ease;
            will-change: transform; /* Optimize for scaling animation */

            display: flex;
            align-items: center;
            justify-content: center;
            
            /* NEW: Styles for PNG icons */
            overflow: hidden; /* Ensure rounded corners clip the image */
            background-size: cover; /* Make sure image fills the swatch */
            background-position: center;
        }
        .icon-swatch:hover {
            transform: scale(1.1); /* Apply pop effect on hover */
            border-color: #ffffff; /* NEW: Add white border on hover */
        }
        .icon-swatch.selected {
	    /* Mobile: Make icons smaller and 3 columns */
	    /* NOTE: The media query that was here was incorrectly nested.
          I moved it to its own block below.
        */
            border-color: #ffffff; /* RE-ADDED: White border on select to "lock" it */
        }
        
        
        /* --- FIX: Moved this media query out of .icon-swatch.selected --- */
        /* Mobile: Make icons smaller */
        
        @media (max-width: 640px) {
            .icon-swatch {
                width: 50px;
                height: 50px;
            }
        }
        
        
        /* NEW: Style for the <img> tag inside the swatch */
        
        .icon-swatch img {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Ensure image covers the area */
        }
        

        /* --- CHAT VIEW STYLES (NEW) --- */
        
        /* This is the main chat view container */
        #chat-view {
            background-color: #000; /* Main chat area is now black */
            
            /* REMOVED max-width to allow fill screen */
            width: 100%;
            height: 100%; /* Take full height */
        }

        #chat-window {
            background-color: #000; /* True black chat window */
            padding: 1rem;
        }

        /* Container for the icon/name + bubble */
        .message-entry {
            display: flex;
            align-items: flex-start;
            margin-bottom: 1.25rem;
            
            /* NEW: Centered message content */
            max-width: 36rem; /* 576px */
            margin-left: auto;
            margin-right: auto;
        }
        
        /* Block for icon and name */
        .icon-name-block {
            width: 60px; /* Fixed width for icon */
            flex-shrink: 0;
            margin-right: 18px; /* Increased distance */
            text-align: center;
        }
        
        /* The icon itself in the chat */
        .user-icon-img { /* UPDATED class name */
            width: 50px; /* Width */
            height: 50px; /* Height */
            border-radius: 0; /* UPDATED: Changed from 4px to 0 for a square */
            display: inline-block; /* Fix for alignment */
            border: 3px solid #fff; /* UPDATED: Changed from 1px to 3px */
            box-sizing: border-box; /* NEW: Pulls border inside the 50x50 box */
            
            /* NEW: Style for PNG */
            object-fit: cover; /* Make sure image fills the box */
            background-color: #333; /* Fallback bg color */
        }
        
        /* Username display under the icon */
        .chat-username {
            font-size: 0.85rem; /* 12px */ /* Changed from 0.75rem for a slightly larger size */
            color: #aaa;
            /* Allow long names to break */
            word-wrap: break-word;
	    padding: 0;
    	    margin: 0;
            line-height: 1;
            display: block;
        }

        /* The speech bubble */
        .message-bubble {
            position: relative;
            /* UPDATED: Gradient background */
            background: linear-gradient(180deg, var(--user-color-light, #fcf6c8) 0%, var(--user-color-dark, #c6b03f) 100%);
            color: #ffffff; /* White text from bubble.jpg */
            text-shadow: 1px 1px 2px rgba(0,0,0,0.4); /* Shadow for readability */
            padding: 0.75rem 1.5rem; /* 12px 24px */
            border-radius: 16px; /* Rounded rectangle from bubble.jpg */
            max-width: calc(100% - 78px); /* Full width minus the icon block */
            border: 4px solid #fff; /* Thick white border */
            box-shadow: 0px 1px 2px rgba(0, 0, 0, 0.2); /* Subtle shadow */
        }
        
        /* The speech bubble pointer (BORDER) */
        .message-bubble::before {
            content: '';
            position: absolute;
            left: -14px;  /* MOVED 4px RIGHT (to hide behind main border) */
            top: 8px;     /* 12px - 4px border */
            width: 0;
            height: 0;
            border-top: 9px solid transparent; /* 5px + 4px border */
            border-bottom: 9px solid transparent; /* 5px + 4px border */
            border-right: 14px solid #fff; /* 10px + 4px border (white) */
        }
        
        /* The speech bubble pointer (FILL) */
        .message-bubble::after {
            content: '';
            position: absolute;
            left: -8px; /* MOVED 4px RIGHT (to hide behind main border) */
            top: 13px;   /* NUDGED 1px DOWN (from 12px) to fix render bug */
            width: 0;
            height: 0;
            border-top: 5px solid transparent; /* Original size */
            border-bottom: 5px solid transparent; /* Original size */
            /* Pointer color matches the bubble gradient */
            border-right: 10px solid var(--user-color-dark, #c6b03f); 
        }
        
        /* Ensure text inside bubble wraps */
        .message-bubble p {
            white-space: pre-wrap;
            word-wrap: break-word;
        }

	/* ← ADD THE NEW CODE RIGHT HERE ↓ */

	/* Mobile: Adjust message layout */
	@media (max-width: 640px) {
	    .message-entry {
	        max-width: 100%;
	        padding: 0 0.5rem;
	    }
    
	    .icon-name-block {
	        width: 45px;
	        margin-right: 10px;
	    }
    
	    .user-icon-img {
	        width: 40px;
	        height: 40px;
	        border: 2px solid #fff;
	    }
    
	    .chat-username {
	        font-size: 0.7rem;
	    }
    
	    .message-bubble {
	        padding: 0.6rem 1rem;
	        font-size: 0.9rem;
	        border: 3px solid #fff;
	        max-width: calc(100% - 55px);
	    }
	}

	/* ← END OF NEW CODE */

	/* NEW: Style for the <img> tag inside the swatch */
	.icon-swatch img {
	    width: 100%;
	    height: 100%;
	    object-fit: cover; /* Ensure image covers the area */
	}
        
        /* NEW Logout Button Style - changed to a profile viewer with logout on click*/
        .profile-display-btn {
            font-family: 'JetBrains Mono', monospace;
            background-color: #000; /* Black background */
            border: none; /* No border */
            color: #f0f0f0;
            padding: 0.5rem 1.25rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            display: flex; /* For icon and text alignment */
            align-items: center;
        }

        .profile-display-btn:hover {
            background-color: #222; /* Slightly lighter on hover */
        }
        .profile-display-btn .user-icon-img { /* UPDATED class */
            margin-right: 8px; /* Space between icon and name */
            width: 30px; /* Smaller icon in header */
            height: 30px;
        }
        
        /* Message Input Area */
        #chat-view footer {
            background-color: #e0e0e0; /* Light gray from image */
            padding-top: 1rem; /* More space above input */
            padding-bottom: 1rem; /* More space below button */
        }

        /* Notification message */
        .notification {
            color: #ffffff; /* White color for notification messages */
            font-style: normal; /* Remove italic */
            text-align: left; /* Left aligned from image */
            padding: 0.5rem 0;
            /* Custom triangles */
            display: flex;
            align-items: center;
            
            /* NEW: Centered message content */
            max-width: 36rem; /* 576px */
            margin-left: auto;
            margin-right: auto;
        }

	/* Mobile: Better input area */
	@media (max-width: 640px) {
	    #message-input {
	        font-size: 16px; /* Prevents iOS zoom on focus */
	        padding: 0.6rem;
	    }
    
	    .drrr-btn {
	        padding: 0.3rem 2rem;
	        font-size: 0.9rem;
	    }
    
	    #logout-button svg {
	        width: 24px;
	        height: 24px;
	    }

	/* Mobile: Touch-friendly spacing */
	@media (max-width: 640px) {
	    .notification {
	        font-size: 0.85rem;
	        padding: 0.4rem 0;
	    }
    
	    #chat-window {
	        padding: 0.5rem;
	    }
    
	    #chat-view footer {
	        padding: 0.75rem;
	    }
	}
	}

        .notification::before {
            content: '► ►'; /* Two solid right-pointing triangles together */
            margin-right: 8px; /* Space after triangles */
            font-size: 1em; /* Adjusted size */
        }

        /* Remove the default italic from the JS-generated message */
        .notification i {
            font-style: normal;
        }
        
        /* NEW: Logout Button beside Message Input */
        #logout-button {
            background: transparent; 
            border: none; 
            color: #000000; /* Black text/icon color */
            
            /* Reduced padding to minimum, adjusted to look visually balanced when aligned to top */
            padding: 0; /* Removed padding */
            margin-left: 0.25rem; /* 12px space */ /* Changed from 0.75rem to move closer */ 
            
            box-shadow: none;
            transition: all 0.2s ease;
            cursor: pointer;
            
            /* Align to the top of the message box */
            align-self: flex-start; 
        }
        
        #logout-button:hover {
            background: transparent; /* Keep background transparent on hover */
            color: #555555; /* Dark gray icon on hover */
        }

        #logout-button svg {
            /* Adjusted size to 22px, as requested */
            width: 28px; /* Increased from 22px */
            height: 28px; /* Increased from 22px */
            fill: currentColor; /* Make SVG color match text color */
        }


        /* --- END CHAT VIEW STYLES --- */


        /* --- STYLES FOR PASSWORD SCREEN (REVISED) --- */
        
        /* --- LOGO STYLES REMOVED --- */
        
        /* Password input styling to match image */
        #password-input {
            background-color: #5a5a5a; /* Gray from image */
            border: 1px solid #888; /* Subtle border from image */
            border-radius: 9999px; /* Pill shape */
            text-align: center;
            font-size: 1rem;
            padding: 0.25rem 1rem; /* Adjusted height (slimmer) */
            box-shadow: none;
            color: #f0f0f0;
            width: 100%; /* Take full width of container */
        }

        #password-input::placeholder {
            color: #ccc;
        }

        #password-input:focus {
            outline: none;
            border-color: #aaa;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
        }

        #password-btn {
            font-family: 'JetBrains Mono', monospace;
            background: #808080; /* 50% gray */
            border: 1px solid #fff; /* White border */
            border-radius: 9999px; /* Pill shape */
            color: #ffffff; /* White text for readability */
            padding: 0.25rem 1.5rem; /* Adjusted height (slimmer) */
            font-size: 1rem; /* UPDATED font size */
            box-shadow: none;
            letter-spacing: 0.1em;
            transition: all 0.2s ease;
            cursor: pointer;
            font-weight: bold;
        }

        #password-btn:hover {
            background: #909090; /* Lighter 50% gray on hover */
            border-color: #fff; /* Keep white border */
        }
        
        #password-btn:disabled {
            background: #444;
            color: #888;
            cursor: not-allowed;
            border-color: #555;
        }
        
        /* NEW STYLE for the "Join" button to match the "ENTER" button */
        .join-btn-drrr {
            font-family: 'JetBrains Mono', monospace;
            background: #808080; /* 50% gray */
            border: 1px solid #fff; /* White border */
            border-radius: 9999px; /* Pill shape */
            color: #ffffff; /* White text */
            padding: 0.25rem 1.5rem; /* UPDATED vertical padding */
            font-size: 1rem; /* Slightly larger font */
            box-shadow: none;
            letter-spacing: 0.1em;
            transition: all 0.2s ease;
            /* width: 100%; */ /* Make it full width - REMOVED */
            font-weight: bold;
        }
        
        .join-btn-drrr:hover {
            background: #909090; /* Lighter 50% gray */
            border-color: #fff;
        }

        .join-btn-drrr:disabled {
            background: #444;
            color: #888;
            cursor: not-allowed;
            border-color: #555;
        }

        #password-error {
            color: #ff5555;
            font-size: 1rem;
            margin-top: 1rem;
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
        }
        
        /* --- NEW: Message Fade/Glow Animation --- */
        @keyframes glowFadeIn {
	    0% {
	        opacity: 0;
	        transform: translateY(-10px) scale(0.95);
	    }
	    60% {
	        opacity: 0.9;
	        transform: translateY(2px) scale(1.01);
	    }
	    100% {
	        opacity: 1;
	        transform: translateY(0) scale(1);
	    }
	}

	.message-pop-animation {
	    animation: glowFadeIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
	}
        
        /* --- NEW: @mention highlight style --- */
        .mention-highlight {
            font-weight: bold;
            color: white; /* Changed from yellow bg */
        }
        
        /* --- ADMIN DELETE BUTTON STYLE (REMOVED) --- */
        
    </style>
</head>
<!-- 
  CHANGE #1: Removed 'h-screen' from the body class.
  The height is now controlled by the CSS in the <style> tag.
-->
<body class="w-screen">

    <!-- 
      App container: Holds both login and chat views
    --><div id="app-container" class="w-full h-full flex flex-col items-center justify-center"> <!-- Center the content -->
        
        <!-- 
          Password View: New screen, shown first
        --><div id="password-view" class="fixed inset-0 z-50 flex flex-col items-center justify-center p-4">
            
            <!-- Logo -->
            <div class="flex-shrink-0">
                <img src="https://raw.githubusercontent.com/boriikatt/drrr-chat/ea76ab0d27004bd9028e2ab492dd29f7d69ee9cb/logo.png" alt="Logo" class="max-w-xl w-full mb-0">
            </div>
            
            <!-- Password Box -->
            <div class="login-box w-full max-w-sm p-6 sm:p-8 rounded-lg text-center pt-0 -mt-4">
                
                <!-- This div constrains the width of the inputs to be narrow --><div class="w-full max-w-[280px] mx-auto">
                    <!-- This div now correctly spaces the input and button --><div class="space-y-4"> <!-- Increased spacing --><!-- Password Input --><div>
                            <input type="password" id="password-input" class="">
                        </div>

                        <!-- Enter Button --><button id="password-btn" class="" disabled>ENTER</button>
                        
                        <!-- Error Message --><p id="password-error" class="text-red-500 text-sm text-center pt-2"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 
          Login View: Fullscreen overlay
        --><div id="login-view" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
            <div class="login-box w-full max-w-md p-4 sm:p-8 rounded-lg">
                <!-- <h1 class="text-2xl sm:text-3xl text-center mb-6 text-white">[ Create Your Profile ]</h1> --><!-- REMOVED --><div class="space-y-6"> <!-- Increased spacing -->
                    
                    <!-- NEW Icon Picker (Label Removed) -->
                    
                    <div>
                        <!-- UPDATED: Changed from flex-wrap to a 4-column grid -->
                        <div id="icon-picker" class="grid grid-cols-3 sm:grid-cols-4 gap-2 sm:gap-3 justify-center max-w-xs mx-auto">
                            <!-- Icons will be injected by JS -->
                        </div>
                    </div>
                    

                    <!-- Color Picker (REMOVED) -->

                    <!-- Username Input (Label Removed) -->
                    <div>
                        <input type="text" id="username-input" placeholder="" class="login-input w-full" maxlength="20">
                    </div>

                    <!-- Join Button (Wrapped for centering) -->
                    <div class="w-full flex justify-center !mt-8">
                        <button id="join-btn" class="join-btn-drrr" disabled>Join</button>
                    </div>
                    
                    <!-- User ID Display (REMOVED) -->
                </div>
            </div>
        </div>

        <!-- 
          Chat View: Main application
        --><div id="chat-view" class="w-full h-full flex flex-col hidden"> <!-- Main container -->
            
            <!-- Message input form (Top) -->
            <footer class="flex-shrink-0 p-4">
                <form id="message-form" class="flex flex-col items-center gap-2 max-w-lg mx-auto">
                    
                    <!-- Container for Message Box and Exit Button -->
                    <div class="w-full flex items-start">
                        <textarea id="message-input" placeholder="" class="drrr-input w-full" rows="3"></textarea>
                        
                        <!-- Exit Button (Minimal) -->
                        <button type="button" id="logout-button">
                            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path fill="currentColor" d="M16 17v-3H9v-4h7V7l5 4-5 4m-7 8c-1.11 0-2-.89-2-2V4a2 2 0 012-2h7a2 2 0 012 2v2h-2V4H9v16h7v-2h2v2a2 2 0 01-2 2Z"/>
                            </svg>
                        </button>
                    </div>
                    
                    <!-- Centered "POST!" Button -->
                    <div class="w-full flex justify-center mt-2">
                        <button type="submit" id="send-btn" class="drrr-btn">POST!</button>
                    </div>
                </form>
            </footer>

            <!-- Main chat window (Bottom) -->
            <main id="chat-window" class="flex-1 overflow-y-auto space-y-3 p-4">
                <!-- Messages will be injected here -->
                <div class="notification">
                    Connecting to server...
                </div>
            </main>
                    
        </div>
    </div>

    <!-- Firebase SDK --><script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged,
            signInWithCustomToken
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            onSnapshot, 
            serverTimestamp, 
            query,
            setLogLevel,
            doc,
            getDoc,
            setDoc,
            getDocs,
            deleteDoc,
            where
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"; 

        // --- NEW: Mobile Height Fix ---
        /**
         * Sets a CSS variable (--app-height) to the window's true inner height.
         * This avoids layout issues with mobile browser toolbars.
         */
        function setAppHeight() {
            const doc = document.documentElement;
            // window.innerHeight accounts for mobile browser toolbars
            doc.style.setProperty('--app-height', `${window.innerHeight}px`);
        }
        
        // Set the height immediately on load
        setAppHeight();
        
        // Add listeners to update height on resize or orientation change
        window.addEventListener('resize', setAppHeight);
        window.addEventListener('orientationchange', setAppHeight);
        // --- END: Mobile Height Fix ---

        // --- ADMIN CONFIG (REMOVED) ---

        // --- App State ---
        let db, auth;
        let currentUserId = null;
        let userName = 'Anonymous';
	
        // --- TONE.JS REMOVED ---
        
	// Add the new functions here:
        function updateUTCTime() {
            const timeDisplay = document.getElementById('utc-time');
            if (!timeDisplay) return;
            
            const now = new Date();
            const utcString = now.toISOString()
                .replace('T', ' ')
                .replace(/\.\d+Z$/, '');
            timeDisplay.textContent = utcString;
        }

        function updateUserLogin() {
            const loginDisplay = document.getElementById('user-login');
            if (!loginDisplay) return;
            loginDisplay.textContent = userName || 'Anonymous';
        }

        // UPDATED: Default color and icon to match the first new icon
        let userColor = '#79b6d8'; // Default color (blue)
        let userIcon = 'icon1'; // UPDATED: Default icon
        let messagesUnsubscribe = null;
        let isInitialLoad = true; // NEW: Flag for first load animation
        
        // Define the color palette (REMOVED)
        
        // --- NEW ICONS OBJECT ---
        // Using raw URLs from your PDF
        const ICONS = {
            'icon1': {
                color: '#79b6d8',
                pngUrl: 'https://raw.githubusercontent.com/boriikatt/drrr-chat/ea76ab0d27004bd9028e2ab492dd29f7d69ee9cb/icon1.png'
            },
            'icon2': {
                color: '#f2a558',
                pngUrl: 'https://raw.githubusercontent.com/boriikatt/drrr-chat/ea76ab0d27004bd9028e2ab492dd29f7d69ee9cb/icon2.png'
            },
            'icon3': {
                color: '#6a6a6a',
                pngUrl: 'https://raw.githubusercontent.com/boriikatt/drrr-chat/ea76ab0d27004bd9028e2ab492dd29f7d69ee9cb/icon3.png'
            },
            'icon4': {
                color: '#c66567',
                pngUrl: 'https://raw.githubusercontent.com/boriikatt/drrr-chat/ea76ab0d27004bd9028e2ab492dd29f7d69ee9cb/icon4.png'
            },
            'icon5': {
                color: '#9ac76a',
                pngUrl: 'https://raw.githubusercontent.com/boriikatt/drrr-chat/ea76ab0d27004bd9028e2ab492dd29f7d69ee9cb/icon5.png'
            },
            'icon6': {
                color: '#df92a5',
                pngUrl: 'https://raw.githubusercontent.com/boriikatt/drrr-chat/ea76ab0d27004bd9028e2ab492dd29f7d69ee9cb/icon6.png'
            },
            'icon7': {
                color: '#a0b484',
                pngUrl: 'https://raw.githubusercontent.com/boriikatt/drrr-chat/ea76ab0d27004bd9028e2ab492dd29f7d69ee9cb/icon7.png'
            },
            'icon8': {
                color: '#79b6d8',
                pngUrl: 'https://raw.githubusercontent.com/boriikatt/drrr-chat/ea76ab0d27004bd9028e2ab492dd29f7d69ee9cb/icon8.png'
            },
            'icon9': {
                color: '#f6dd6b',
                pngUrl: 'https://raw.githubusercontent.com/boriikatt/drrr-chat/ea76ab0d27004bd9028e2ab492dd29f7d69ee9cb/icon9.png'
            },
            'icon10': {
                color: '#a9a9a9',
                pngUrl: 'https://raw.githubusercontent.com/boriikatt/drrr-chat/ea76ab0d27004bd9028e2ab492dd29f7d69ee9cb/icon10.png'
            },
            'icon11': {
                color: '#5a5a5a',
                pngUrl: 'https://raw.githubusercontent.com/boriikatt/drrr-chat/ea76ab0d27004bd9028e2ab492dd29f7d69ee9cb/icon11.png'
            },
            'icon12': {
                color: '#dec09e',
                pngUrl: 'https://raw.githubusercontent.com/boriikatt/drrr-chat/ea76ab0d27004bd9028e2ab492dd29f7d69ee9cb/icon12.png'
            },
            'icon13': {
                color: '#c7a3d1',
                pngUrl: 'https://raw.githubusercontent.com/boriikatt/drrr-chat/ea76ab0d27004bd9028e2ab492dd29f7d69ee9cb/icon13.png'
            },
            'icon14': {
                color: '#e57373',
                pngUrl: 'https://raw.githubusercontent.com/boriikatt/drrr-chat/ea76ab0d27004bd9028e2ab492dd29f7d69ee9cb/icon14.png'
            },
            'icon15': {
                color: '#e0809b',
                pngUrl: 'https://raw.github.com/boriikatt/drrr-chat/blob/ea76ab0d27004bd9028e2ab492dd29f7d69ee9cb/icon15.png?raw=true'
            },
            'icon16': {
                color: '#e79e8b',
                pngUrl: 'https://raw.githubusercontent.com/boriikatt/drrr-chat/ea76ab0d27004bd9028e2ab492dd29f7d69ee9cb/icon16.png'
            }
        };


        // --- DOM Elements ---
        const passwordView = document.getElementById('password-view');
        const passwordInput = document.getElementById('password-input');
        const passwordBtn = document.getElementById('password-btn');
        const passwordError = document.getElementById('password-error');

        const loginView = document.getElementById('login-view');
        const chatView = document.getElementById('chat-view');
        const usernameInput = document.getElementById('username-input');
        const joinBtn = document.getElementById('join-btn');
        const chatWindow = document.getElementById('chat-window');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const colorPicker = document.getElementById('color-picker'); // This will be null, which is fine
        const iconPicker = document.getElementById('icon-picker');
        const userIdDisplay = document.getElementById('user-id-display'); // This will now be null, which is fine
        const logoutButton = document.getElementById('logout-button');

        // --- Firebase Config (GLOBAL VARS) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'drrr-chat-default';
        let firebaseConfig;

        // --- USER-CONFIG-START ---
        
        // FIX #2: Pasted in your specific Firebase config block.
        const localFirebaseConfig = {
	  apiKey: "AIzaSyDEol7Fw-tYwBPouqRN7MnHGfzp1NHTtcc",
	  authDomain: "dollars-chat-baf1d.firebaseapp.com",
	  projectId: "dollars-chat-baf1d",
	  storageBucket: "dollars-chat-baf1d.firebasestorage.app",
	  messagingSenderId: "147026423155",
	  appId: "1:147026423155:web:e12155a019b49394f92906"
	};
        
        // --- USER-CONFIG-END ---


        // --- Helper Functions (Defined early to be available) ---
        
        /**
         * Displays a notification in the chat window
         * @param {string} message - The text to display
         * @param {boolean} [isError=false] - If true, styles as an error
         */
        function displayNotification(message, isError = false) {
            // Check if chatWindow exists, otherwise log to console as a fallback
            if (chatWindow) {
                // Check if a notification element already exists
                let notificationEl = chatWindow.querySelector('.notification');
                if (!notificationEl) {
                    notificationEl = document.createElement('div');
                    notificationEl.className = 'notification';
                    chatWindow.appendChild(notificationEl);
                }
                notificationEl.className = `notification ${isError ? 'text-red-500' : ''}`; // Keep 'notification' class
                notificationEl.innerHTML = `<i>${message}</i>`; // Only the message content
                
            } else {
                console.log(`NOTIFICATION (${isError ? 'ERROR' : 'INFO'}): ${message}`);
            }
        }

        /**
         * Sends a system notification message (e.g., "User joined")
         * @param {string} message - The notification text
         */
        async function sendNotificationMessage(message) {
            // SYNTAX ERROR FIX: Changed the invalid 'return.catch' to a proper guard clause.
            if (!currentUserId || !db) {
                console.error("Notification send failed: No user ID or DB connection.");
                return; 
            }
            
            const messagesRef = collection(db, `artifacts/${appId}/public/data/drrr-chat-messages`);
            
            try {
                await addDoc(messagesRef, {
                    type: 'notification',
                    message: message,
                    timestamp: serverTimestamp()
                });
            } catch (error) {
                console.error("Error sending notification:", error);
            }
        }


        try {
            // Try to get config from the platform first
            firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null; 
            if (!firebaseConfig) {
                // If not available, use the local config
                if (typeof localFirebaseConfig !== 'undefined' && localFirebaseConfig.apiKey) { // Check if apiKey exists
                    firebaseConfig = localFirebaseConfig;
                    console.log("Using local Firebase config.");
                } else {
                    throw new Error("Firebase config is not available.");
                }
            } else {
                console.log("Using platform Firebase config.");
            }
        } catch (e) {
            console.error("Failed to parse Firebase config:", e);
            // Show the error on the password screen instead of making it blank
            if(passwordError) {
                passwordError.innerHTML = "FATAL: App configuration is missing.<br>Please paste your 'localFirebaseConfig' into the script.";
            }
        }

        // --- Firebase Initialization ---
        try {
            if (firebaseConfig) {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setLogLevel('debug');
                console.log("Firebase Initialized");
            } else {
                throw new Error("Firebase config is missing, skipping initialization.");
            }
        } catch (e) {
            console.error("Error initializing Firebase:", e);
             if(passwordError) {
                passwordError.innerHTML = "Error: Could not initialize chat service.";
            }
        }

        // --- Auth Management ---
        if (auth) {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // User is signed in
                    currentUserId = user.uid;
                    // Check if userIdDisplay exists before setting textContent
                    if (userIdDisplay) {
                        userIdDisplay.textContent = currentUserId;
                    }
                    console.log("User signed in:", currentUserId);

                    // --- ADMIN CHECK (REMOVED) ---
                    
                    // Enable buttons now that auth is ready
                    if (passwordBtn) {
                        passwordBtn.disabled = false;
                    }
                    if (joinBtn) {
                        joinBtn.disabled = false;
                    }

                } else {
                    // User is signed out
                    currentUserId = null;
                    // --- ADMIN RESET (REMOVED) ---
                    console.log("User signed out.");

                    // Disable buttons if user signs out
                    if (passwordBtn) {
                        passwordBtn.disabled = true;
                    }
                    if (joinBtn) {
                        joinBtn.disabled = true;
                    }

                    // Try to sign in again
                    await attemptAnonymousLogin();
                }
            });
        }

        async function attemptAnonymousLogin() {
            if (!auth) {
                console.error("Auth is not initialized, cannot attempt login.");
                return;
            }

            const loginFn = async () => {
                const authToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                // Use platform token if available, otherwise sign in anonymously (for local testing)
                if (authToken) {
                    await signInWithCustomToken(auth, authToken);
                    console.log("Signed in with custom token.");
                } else {
                    await signInAnonymously(auth);
                    console.log("Signed in anonymously (local).");
                }
            };
            
            // Add retry logic for network errors
            let attempt = 0;
            const maxRetries = 3;
            let currentDelay = 1000; // start with 1 second

            while (attempt < maxRetries) {
                try {
                    await loginFn(); 
                    return; // Success, exit the function
                } catch (error) {
                    attempt++;
                    // Only retry on network errors and if we haven't exhausted retries
                    if (error.code === 'auth/network-request-failed' && attempt < maxRetries) {
                        console.log(`Login attempt ${attempt} failed due to network error. Retrying in ${currentDelay}ms...`);
                        await new Promise(resolve => setTimeout(resolve, currentDelay));
                        currentDelay *= 2; // Exponential backoff
                    } else {
                        // Not a network error or retries exhausted, throw the error
                        console.error(`Error during sign-in (attempt ${attempt}):`, error);
                        // Check if userIdDisplay exists
                        if (userIdDisplay) {
                            userIdDisplay.textContent = "Error";
                        }
                        if(passwordError) {
                             passwordError.innerHTML = "Error: Could not authenticate.<br>Check console for details.";
                        }
                        return; // Stop trying
                    }
                }
            }
        }

        // --- UI Initialization ---
        
        // NEW: Initialize Icon Picker
        
        function initializeIconPicker() {
            if (!iconPicker) {
                console.error("iconPicker element not found.");
                return;
            }
            
            // Clear picker in case of re-initialization
            iconPicker.innerHTML = '';
            
            // UPDATED: Iterate over new ICONS object
            Object.entries(ICONS).forEach(([iconName, iconData]) => {
                const swatch = document.createElement('div');
                swatch.className = 'icon-swatch';
                
                // UPDATED: Create <img> tag
                const img = document.createElement('img');
                img.src = iconData.pngUrl;
                img.alt = iconName;
                // Add fallback to use bg color if image fails
                img.onerror = () => { 
                    img.style.display = 'none'; // Hide broken image
                    swatch.style.backgroundColor = iconData.color; 
                };
                swatch.appendChild(img);

                swatch.dataset.icon = iconName;
                
                /* REMOVED: No icon is selected by default anymore
                if (iconName === userIcon) {
                    swatch.classList.add('selected');
                }
                */
                
                swatch.addEventListener('click', () => {
                    userIcon = iconName; // Set the icon name (e.g., 'male-blue')
                    userColor = iconData.color; // Set the user color (e.g., '#79b6d8')
                    
                    // Remove 'selected' from all swatches
                    document.querySelectorAll('.icon-swatch').forEach(s => {
                        s.classList.remove('selected');
                    });
                    // Add 'selected' to the clicked one
                    swatch.classList.add('selected');
                });
                
                iconPicker.appendChild(swatch);
            });
        }
        
        
        // UPDATED: Initialize Color Picker (REMOVED)
        
        /**
         * UPDATED: Creates the user icon <img>
         * @param {string} color - The user's chosen hex color (fallback)
         * @param {string} iconName - The name of the icon
         * @param {number} [size=50] - The size of the icon (width/height)
         * @returns {string} - An HTML string for the <img>
         */
        function createUserIcon(color, iconName, size = 50) {
            // Find the icon data from the ICONS object
            const iconData = ICONS[iconName] || ICONS[Object.keys(ICONS)[0]]; // Fallback to first icon
            const iconUrl = iconData.pngUrl;
            // Use the color passed from the message, or the icon's default color as a fallback
            const bgColor = color || iconData.color;
            
            // UPDATED: Return an <img> tag
            return `
                <img src="${iconUrl}" 
                     width="${size}" 
                     height="${size}" 
                     class="user-icon-img" 
                     style="background-color: ${bgColor};"
                     alt="User Icon"
                     onerror="this.style.display='none'; this.parentElement.style.backgroundColor='${bgColor}';"
                >
            `;
        }
        
        /**
         * Scrolls the chat window to the top (for newest-first)
         */
        function scrollToTop() {
            if (chatWindow) {
                chatWindow.scrollTop = 0;
            }
        }

        // --- Password Check ---
        /**
         * Checks the password and proceeds to login screen or chat
         */
        async function checkPassword() { // CHANGED: Made async
            // --- TONE.JS REMOVED ---
            const pass = passwordInput.value.trim();
            if (pass.toLowerCase() === 'betka') { 
                passwordError.textContent = '';
                // NEW: Load profile *after* password is correct and *before* hiding
                passwordView.classList.add('hidden'); // Hide AFTER loading
		await loadUserProfile(currentUserId);                
            } else {
                passwordError.textContent = '> Access Denied.';
                passwordInput.value = '';
                passwordInput.focus();
            }
        }

        // --- NEW: Load User Profile ---
        /**
         * Loads user profile from Firestore or shows login screen.
         * @param {string} userId - The current user's UID
         */
        async function loadUserProfile(userId) {
            if (!userId) {
                console.error("No user ID, cannot load profile.");
                loginView.classList.remove('hidden'); // Fallback to login
                return;
            }
            
            // Use the private user-specific path
            const profileDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile`, "settings");
            
            try {
                const docSnap = await getDoc(profileDocRef);
                if (docSnap.exists()) {
                    // Profile exists: Load it and go to chat
                    const data = docSnap.data();
                    userName = data.username;
                    // Check if icon and color exist in our new ICONS list
                    if (data.icon && ICONS[data.icon]) {
                        userIcon = data.icon;
                        userColor = data.color;
                    } else {
                        // Fallback to first icon if saved icon is invalid
                        userIcon = Object.keys(ICONS)[0];
                        userColor = ICONS[userIcon].color;
                    }
                    console.log("User profile loaded:", data);

                    // Skip login, go straight to chat
                    chatView.classList.add('flex');
                    chatView.classList.remove('hidden');
                    subscribeToMessages();
                    
                    sendNotificationMessage(`@${userName} logged in.`);
                } else {
                    // No profile: Show login screen to create one
                    console.log("No profile found for user. Showing login screen.");
                    loginView.classList.remove('hidden');
                }
            } catch (e) {
                console.error("Error loading profile:", e);
                loginView.classList.remove('hidden'); // Fallback to login
            }
        }
        
        // --- Chat Logic ---

        /**
         * Called when user clicks "Join"
         */
        async function joinChat() {
            // --- TONE.JS REMOVED ---
            if (!currentUserId) {
                console.error("Error: Not connected. Please wait and try again.");
                return;
            }
            
            // Check if usernameInput exists
            const username = usernameInput ? usernameInput.value.trim() : '';
            if (username) {
                userName = username;
            }

            // Check if an icon was selected, if not, pick the first one
            if (!userIcon || !ICONS[userIcon]) {
                 userIcon = Object.keys(ICONS)[0];
                 userColor = ICONS[userIcon].color;
            }
            
            console.log(`Joining as: ${userName} (${userColor}) with icon: ${userIcon}`);
            
            // NEW: Save the profile to Firestore
            const profileData = {
                username: userName,
                color: userColor, // Save the selected color
                icon: userIcon  // Save the selected icon name
            };
            try {
                const profileDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile`, "settings");
                await setDoc(profileDocRef, profileData);
                console.log("Profile saved.");
            } catch (e) {
                console.error("Error saving profile:", e);
                // Don't block, just log the error and continue
            }

            // Hide login, show chat
            if (loginView) loginView.classList.add('hidden');
            if (chatView) {
                chatView.classList.add('flex');
                chatView.classList.remove('hidden');
            }
            
            // Subscribe to messages
            subscribeToMessages();
            
            // Send "joined" notification
            sendNotificationMessage(`@${userName} logged in.`);
        }

        /**
         * Logs the user out (refreshes the page)
         */
        async function logout() {
	    // Send and forget (fire-and-forget pattern)
	    sendNotificationMessage(`@${userName} logged out.`).catch(err => {
	        console.error("Failed to send logout notification:", err);
	    });
    
	    // Continue with logout immediately...
            
            // No matter if sending worked, log out the UI
            
            // Hide chat view
            if (chatView) {
                chatView.classList.add('hidden');
                chatView.classList.remove('flex');
            }

            // Show PASSWORD view
            if (passwordView) {
                passwordView.classList.remove('hidden');
            }
            if (passwordInput) {
                passwordInput.value = ''; // Clear password field
            }
            if (passwordError) {
                passwordError.textContent = ''; // Clear any old errors
            }

            // Unsubscribe from messages
            if (messagesUnsubscribe) {
                messagesUnsubscribe();
                messagesUnsubscribe = null;
            }

            // Clear chat window
            if (chatWindow) {
                chatWindow.innerHTML = '';
            }

            // Reset username
            if (usernameInput) {
                usernameInput.value = '';
            }
            userName = 'Anonymous';
            // Don't reset userIcon or userColor, keep preferences
        }
        
        // --- Message Logic ---

        /**
         * Sets up the real-time listener for chat messages
         */
        function subscribeToMessages() {
            if (messagesUnsubscribe) {
                messagesUnsubscribe();
            }

            if (!db) {
                console.error("Firestore (db) is not initialized. Cannot subscribe to messages.");
                displayNotification("Error: Database not connected.", true);
                return;
            }
            
            // Use the public path
            const messagesRef = collection(db, `artifacts/${appId}/public/data/drrr-chat-messages`);
            const q = query(messagesRef);
            
            messagesUnsubscribe = onSnapshot(q, (snapshot) => {
                const messages = [];
                snapshot.forEach(doc => {
                    messages.push({ id: doc.id, ...doc.data() });
                });
                
                // Sort messages by timestamp on the client-side
                // Newest first
                messages.sort((a, b) => {
                    const tsA = a.timestamp?.seconds ?? Infinity;
                    const tsB = b.timestamp?.seconds ?? Infinity;
                    
                    if (tsA === 0) return -1; // Force 0 to bottom
                    if (tsB === 0) return 1;  // Force 0 to bottom

                    return tsB - tsA;
                });
                
                renderMessages(messages);
                isInitialLoad = false; // Set flag after first render
                
            }, (error) => {
                console.error("Error subscribing to messages:", error);
                displayNotification("Error: Lost connection to chat.", true);
            });
        }
        
        /**
         * Renders the array of message objects to the chat window
         * @param {Array<Object>} messages - Array of message objects from Firestore
         */
        function renderMessages(messages) {
            if (!chatWindow) return;
            
            const scrollBuffer = 50; 
            const isScrolledToTop = chatWindow.scrollTop <= scrollBuffer;

            chatWindow.innerHTML = ''; // Clear the window
            
            if (messages.length === 0) {
                displayNotification("Connecting to server...");
                return;
            }
            
            messages.forEach((msg, index) => {
                const msgEl = document.createElement('div');
                
                // Sanitize message content (basic text replacement)
                // Also check for @mentions
                let sanitizedMessage = (msg.message || "")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;");

                // NEW: @mention check
                const mentionString = `@${userName}`;
                if (sanitizedMessage.includes(mentionString)) {
                    // Use a regex to replace all instances
                    const regex = new RegExp(mentionString, 'g');
                    sanitizedMessage = sanitizedMessage.replace(regex, `<span class="mention-highlight">${mentionString}</span>`);
                }


                if (msg.type === 'notification') {
                    // System Notification
                    msgEl.className = 'notification';
                    msgEl.innerHTML = `<i>${sanitizedMessage}</i>`; 
                } else {
                    // User Message
                    msgEl.className = 'message-entry';
                    
                    // Deriving light/dark colors for the gradient:
                    let baseColor = msg.color || userColor; // Use color from message
                    let lightColor = baseColor;
                    let darkColor = baseColor;
                    let textColor = '#ffffff'; // Default to WHITE text

                    // Check if color is light or dark (simple brightness check)
                    try {
                        let r = parseInt(baseColor.slice(1, 3), 16);
                        let g = parseInt(baseColor.slice(3, 5), 16);
                        let b = parseInt(baseColor.slice(5, 7), 16);
                        
                        // Using a standard brightness formula
                        const brightness = (r * 299 + g * 587 + b * 114) / 1000;
                        
                        if (brightness > 125) {
                            // It's a light color, make text WHITE (as requested)
                            textColor = '#ffffff';
                            // Darken for the bottom gradient
                            darkColor = `rgb(${Math.max(0, r - 40)}, ${Math.max(0, g - 40)}, ${Math.max(0, b - 40)})`;
                            lightColor = `rgb(${Math.min(255, r + 20)}, ${Math.min(255, g + 20)}, ${Math.min(255, b + 20)})`;
                        } else {
                            // It's a dark color, make text white
                            textColor = '#ffffff';
                             // Lighten for the top gradient
                            lightColor = `rgb(${Math.min(255, r + 40)}, ${Math.min(255, g + 40)}, ${Math.min(255, b + 40)})`;
                            darkColor = `rgb(${Math.max(0, r - 20)}, ${Math.max(0, g - 20)}, ${Math.max(0, b - 20)})`;
                        }

                    } catch (e) {
                        console.warn("Invalid color format, falling back to defaults.", e);
                        lightColor = '#fcf6c8';
                        darkColor = '#c6b03f';
                        textColor = '#ffffff'; // Default to white
                    }

                    msgEl.style.setProperty('--user-color-light', lightColor);
                    msgEl.style.setProperty('--user-color-dark', darkColor);
                    
                    // UPDATED: Create icon with color and icon name
                    const icon = createUserIcon(msg.color, msg.icon, 50); // 50px icon
                    
                    // Sanitize username
                    const sanitizedUsername = (msg.username || 'Anonymous')
                        .replace(/</g, "&lt;")
                        .replace(/>/g, "&gt;");
                    
                    // --- ADMIN DELETE BUTTON (REMOVED) ---
                    
                    msgEl.innerHTML = `
                        <div class="icon-name-block">
                            ${icon}
                            <div class="chat-username">${sanitizedUsername}</div>
                        </div>
                        <div class="message-bubble" style="color: ${textColor};">
                            <p>${sanitizedMessage}</p>
                        </div>
                    `;
                    // Set the pointer fill color to match the dark gradient part
                    msgEl.querySelector('.message-bubble').style.setProperty('--user-color-dark', darkColor);
                }

                // NEW: Animation and Sound logic
                // Animate and play sound only for the first message (newest)
                // And only if it's a new message (not part of the initial load)
                // And only if it's NOT a notification
                if (index === 0 && !isInitialLoad && msg.type !== 'notification') {
                    // Check if it's a local-only message (no server timestamp yet)
                    if (!msg.timestamp) {
                        msgEl.classList.add('message-pop-animation');
                    }
                    
                    // --- TONE.JS REMOVED ---
                }
                
                chatWindow.appendChild(msgEl);
            });
            
            if (isScrolledToTop) {
                // If we were at the top, scroll to the new top
                scrollToTop();
            }
        }
 
        // --- FIX: Removed the duplicate renderMessages function block ---
 
        // --- ADMIN DELETE MESSAGE FUNCTION (REMOVED) ---
 
        /**
         * Sends a user message to Firestore
         * @param {Event} e - The form submit event
         */
        async function handleSendMessage(e) {
            e.preventDefault();
            const messageText = messageInput.value.trim();
            
            if (!messageText) return; // Don't send empty messages
            if (!currentUserId) {
                console.error("Error: Not connected. Message not sent.");
                return;
            }
            if (!db) {
                 console.error("Error: DB not connected. Message not sent.");
                 return;
            }
            
            // Disable send button to prevent spam
            if(sendBtn) sendBtn.disabled = true;
            if(messageInput) messageInput.disabled = true;
            
            const messagesRef = collection(db, `artifacts/${appId}/public/data/drrr-chat-messages`);
            
            try {
                // UPDATED: Send icon name with message
                await addDoc(messagesRef, {
                    username: userName,
                    message: messageText,
                    color: userColor, // Send the selected color
                    icon: userIcon, // Send the selected icon name
                    userId: currentUserId,
                    timestamp: serverTimestamp() // Let the server set the time
                });
                
                // Clear input
                if(messageInput) messageInput.value = '';
                
            } catch (error) {
                console.error("Error sending message:", error);
                // Do not use alert()
            } finally {
                // Re-enable send-button
                if(sendBtn) sendBtn.disabled = false;
                if(messageInput) {
                    messageInput.disabled = false;
                    messageInput.focus();
                }
            }
        }
        
        // --- Event Listeners ---

        if (passwordBtn) {
            passwordBtn.addEventListener('click', checkPassword);
        }
        if (passwordInput) {
            passwordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    checkPassword();
                }
            });
        }

        if (joinBtn) {
            joinBtn.addEventListener('click', joinChat);
        }
        if (usernameInput) {
            usernameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    joinChat();
                }
            });
        }

        if (messageForm) {
            messageForm.addEventListener('submit', handleSendMessage);
        }

        // NEW: Add keypress listener for textarea
        if (messageInput) {
            messageInput.addEventListener('keypress', (e) => {
                // Send on Enter (but not Shift+Enter)
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault(); // Stop newline
                    
                    // Manually trigger the form submission
                    if (typeof messageForm.requestSubmit === 'function') {
                        messageForm.requestSubmit();
                    } else {
                         // Fallback for older browsers
                        const submitEvent = new Event('submit', { bubbles: true, cancelable: true });
                        messageForm.dispatchEvent(submitEvent);
                    }
                }
                // Allow Shift+Enter to create a new line (which is the default behavior)
            });
        }

        // NEW: Logout button listener
        if (logoutButton) {
            logoutButton.addEventListener('click', logout);
        }
        
        // --- ADMIN DELETE BUTTON LISTENER (REMOVED) ---
        
        // --- App Start ---
        // Only run app logic if firebase was successfully configured
        if (firebaseConfig) {
            initializeIconPicker();
            // initializeColorPicker(); // REMOVED
            
	   // Add these lines here:
    	   updateUTCTime();
    	   setInterval(updateUTCTime, 1000);
    	   updateUserLogin();

            // WRAP in async IIFE to allow top-level await
            (async () => {
                if (auth) {
                    await attemptAnonymousLogin();
                } else {
                    if(passwordError) {
                        passwordError.innerHTML = "FATAL: Auth service failed to initialize.";
                    }
                }
            })();

        } else {
            // This error handling is now correct.
            console.error("Firebase config is missing. App cannot start. Please paste your 'localFirebaseConfig' object into the script.");
            if (passwordError) {
                passwordError.innerHTML = `FATAL: App configuration is missing.<br>Please paste your 'localFirebaseConfig' into the script.`;
            }
        }
        
    </script>

</body>
</html>
